# –ù–æ–≤–∞—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏

## üìã –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å

### 1. –¢–∞–±–ª–∏—Ü–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (`transactions`)
–¢–µ–ø–µ—Ä—å –∫–∞–∂–¥–∞—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É —Å:
- **–£–Ω–∏–∫–∞–ª—å–Ω—ã–º UUID** - –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
- **–ë–∞–ª–∞–Ω—Å–æ–º –¥–æ –∏ –ø–æ—Å–ª–µ** - –ø–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç
- **–°–≤—è–∑—å—é —Å –æ–ø–µ—Ä–∞—Ü–∏–µ–π** - —Å—Å—ã–ª–∫–∞ –Ω–∞ payout –∏–ª–∏ withdrawal
- **–°—Ç–∞—Ç—É—Å–æ–º** - pending, completed, cancelled, failed
- **–ò—Å—Ç–æ—Ä–∏–µ–π –æ—Ç–º–µ–Ω—ã** - –∫—Ç–æ, –∫–æ–≥–¥–∞ –∏ –ø–æ—á–µ–º—É –æ—Ç–º–µ–Ω–∏–ª

### 2. –§—É–Ω–∫—Ü–∏–∏ PostgreSQL

#### `create_transaction()`
–°–æ–∑–¥–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –∞—Ç–æ–º–∞—Ä–Ω–æ:
- –ë–ª–æ–∫–∏—Ä—É–µ—Ç —Å—Ç—Ä–æ–∫—É –ø—Ä–æ—Ñ–∏–ª—è (FOR UPDATE)
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç—å —Å—Ä–µ–¥—Å—Ç–≤
- –°–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- –û–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å
- –í—Å–µ –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ë–î

#### `cancel_transaction()`
–û—Ç–º–µ–Ω—è–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏:
- ‚ùå –ù–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å –µ—Å–ª–∏ –±—ã–ª–∏ –≤—ã–≤–æ–¥—ã –ø–æ—Å–ª–µ
- ‚ùå –ù–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å —É–∂–µ –æ—Ç–º–µ–Ω–µ–Ω–Ω—É—é
- ‚úì –°–æ–∑–¥–∞–µ—Ç –æ–±—Ä–∞—Ç–Ω—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úì –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø—Ä–∏—á–∏–Ω—É –∏ –∞–≤—Ç–æ—Ä–∞ –æ—Ç–º–µ–Ω—ã

## üöÄ –ü–æ—Ä—è–¥–æ–∫ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

### –®–∞–≥ 1: –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
```sql
-- –í—ã–ø–æ–ª–Ω–∏—Ç—å –≤ Supabase SQL Editor:
\i sql/create_transactions_table.sql
```

### –®–∞–≥ 2: –û–±–Ω—É–ª–∏—Ç—å –≤—Å–µ –±–∞–ª–∞–Ω—Å—ã (–û–ü–¶–ò–û–ù–ê–õ–¨–ù–û)
‚ö†Ô∏è **–í–ù–ò–ú–ê–ù–ò–ï**: –≠—Ç–æ —É–¥–∞–ª–∏—Ç –í–°–ï —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ!

```sql
-- –í—ã–ø–æ–ª–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω—É–∂–µ–Ω –ø–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å:
\i sql/reset_all_balances.sql
```

### –®–∞–≥ 3: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
–ù–æ–≤—ã–π –∫–æ–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.

## üéØ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –≤—ã–ø–ª–∞—Ç—ã
```
1. –ê–¥–º–∏–Ω –∑–∞–ø–æ–ª–Ω—è–µ—Ç —Ñ–æ—Ä–º—É –≤—ã–ø–ª–∞—Ç—ã
2. –°–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ `payouts`
3. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `create_transaction()`
   ‚îú‚îÄ –ë–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   ‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –±–∞–ª–∞–Ω—Å
   ‚îú‚îÄ –°–æ–∑–¥–∞–µ—Ç—Å—è transaction —Å type='payout'
   ‚îî‚îÄ –ë–∞–ª–∞–Ω—Å —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –∞—Ç–æ–º–∞—Ä–Ω–æ
4. ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ metadata
```

### –û—Ç–º–µ–Ω–∞ –≤—ã–ø–ª–∞—Ç—ã
```
1. –ê–¥–º–∏–Ω –Ω–∞–∂–∏–º–∞–µ—Ç "–£–¥–∞–ª–∏—Ç—å" –Ω–∞ –≤—ã–ø–ª–∞—Ç–µ
2. –ò—â–µ—Ç—Å—è —Å–≤—è–∑–∞–Ω–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ø–æ reference_id
3. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `cancel_transaction()`
   ‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞: –±—ã–ª–∏ –ª–∏ –≤—ã–≤–æ–¥—ã –ø–æ—Å–ª–µ?
   ‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞: –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ —Å—Ä–µ–¥—Å—Ç–≤?
   ‚îú‚îÄ –°–æ–∑–¥–∞–µ—Ç—Å—è –æ–±—Ä–∞—Ç–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è (correction)
   ‚îú‚îÄ –ë–∞–ª–∞–Ω—Å —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è
   ‚îî‚îÄ –ò—Å—Ö–æ–¥–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ø–æ–º–µ—á–∞–µ—Ç—Å—è cancelled
4. –í—ã–ø–ª–∞—Ç–∞ —É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ `payouts`
```

### –í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤
```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–µ—Ç –∑–∞—è–≤–∫—É –Ω–∞ –≤—ã–≤–æ–¥
2. –°—Ä–µ–¥—Å—Ç–≤–∞ –∑–∞–º–æ—Ä–∞–∂–∏–≤–∞—é—Ç—Å—è (—Å–æ–∑–¥–∞–µ—Ç—Å—è withdrawal transaction)
3. –ê–¥–º–∏–Ω –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç:
   - Approved ‚Üí —Å—Ä–µ–¥—Å—Ç–≤–∞ –æ—Å—Ç–∞—é—Ç—Å—è –∑–∞–º–æ—Ä–æ–∂–µ–Ω–Ω—ã–º–∏
   - Rejected ‚Üí —Å–æ–∑–¥–∞–µ—Ç—Å—è refund transaction, –¥–µ–Ω—å–≥–∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è
   - Completed ‚Üí –¥–µ–Ω—å–≥–∏ —Å—á–∏—Ç–∞—é—Ç—Å—è –≤—ã–ø–ª–∞—á–µ–Ω–Ω—ã–º–∏
```

## üîí –ó–∞—â–∏—Ç–∞ –æ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤

### 1. –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- UUID –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç

### 2. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- FOR UPDATE –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å—Ç—Ä–æ–∫—É –ø—Ä–æ—Ñ–∏–ª—è
- Concurrent –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
- Race conditions –Ω–µ–≤–æ–∑–º–æ–∂–Ω—ã

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∏ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏
- –ë–∞–ª–∞–Ω—Å –≤—Å–µ–≥–¥–∞ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π
- –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –Ω–µ–∏–∑–º–µ–Ω–Ω–∞ (—Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ)
- –û—Ç–º–µ–Ω—ã –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ, –Ω–µ —É–¥–∞–ª—è—é—Ç –∏—Å—Ç–æ—Ä–∏—é

### 4. Referential Integrity
- transaction.reference_id ‚Üí payout.id –∏–ª–∏ withdrawal.id
- Cascade delete —É–¥–∞–ª–∏—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è
- Orphan transactions –Ω–µ–≤–æ–∑–º–æ–∂–Ω—ã

## üìä –ê—É–¥–∏—Ç –∏ –æ—Ç—á–µ—Ç—ã

### –ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```sql
SELECT 
  user_id,
  SUM(CASE WHEN type IN ('payout', 'refund') THEN amount ELSE -amount END) as calculated_balance
FROM transactions
WHERE status = 'completed'
GROUP BY user_id;
```

### –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π
```sql
SELECT 
  t.*,
  p.nickname,
  p.email
FROM transactions t
JOIN profiles p ON p.id = t.user_id
ORDER BY t.created_at DESC;
```

### –û—Ç–º–µ–Ω–µ–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
```sql
SELECT 
  t.*,
  canceller.email as cancelled_by_email
FROM transactions t
LEFT JOIN profiles canceller ON canceller.id = t.cancelled_by
WHERE t.status = 'cancelled'
ORDER BY t.cancelled_at DESC;
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–°—Ç–∞—Ä—ã–µ –≤—ã–ø–ª–∞—Ç—ã** - –≤—ã–ø–ª–∞—Ç—ã —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –¥–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –Ω–µ –∏–º–µ—é—Ç —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π. –ò—Ö –æ—Ç–º–µ–Ω–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.

2. **–ú–∏–≥—Ä–∞—Ü–∏—è** - –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω—É–∂–µ–Ω –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç (–Ω–µ –≤–∫–ª—é—á–µ–Ω).

3. **–û—Ç–∫–∞—Ç—ã** - —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å, —Ç–æ–ª—å–∫–æ –æ—Ç–º–µ–Ω–∏—Ç—å. –ò—Å—Ç–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é.

4. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –∏–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã –Ω–∞ –≤—Å–µ—Ö –∫–ª—é—á–µ–≤—ã—Ö –ø–æ–ª—è—Ö. –ó–∞–ø—Ä–æ—Å—ã –±—ã—Å—Ç—Ä—ã–µ –¥–∞–∂–µ —Å –º–∏–ª–ª–∏–æ–Ω–∞–º–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.

## üêõ –û—Ç–ª–∞–¥–∫–∞

### –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –±–∞–ª–∞–Ω—Å–∞
```sql
-- –ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ–º:
SELECT 
  p.id,
  p.email,
  p.balance as current_balance,
  COALESCE(SUM(CASE 
    WHEN t.type IN ('payout', 'refund') THEN t.amount 
    ELSE -t.amount 
  END), 0) as calculated_balance,
  p.balance - COALESCE(SUM(CASE 
    WHEN t.type IN ('payout', 'refund') THEN t.amount 
    ELSE -t.amount 
  END), 0) as difference
FROM profiles p
LEFT JOIN transactions t ON t.user_id = p.id AND t.status = 'completed'
GROUP BY p.id
HAVING ABS(p.balance - COALESCE(SUM(CASE 
  WHEN t.type IN ('payout', 'refund') THEN t.amount 
  ELSE -t.amount 
END), 0)) > 0.01;
```

### –ò—Å–ø—Ä–∞–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å –≤—Ä—É—á–Ω—É—é
```sql
-- –°–æ–∑–¥–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é—â—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é:
SELECT create_transaction(
  'USER_UUID'::uuid,
  'correction',
  100.00, -- —Å—É–º–º–∞ –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏
  NULL,
  NULL,
  '–†—É—á–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ü–∏—è –±–∞–ª–∞–Ω—Å–∞',
  '{"reason": "Admin correction"}'::jsonb,
  'ADMIN_UUID'::uuid
);
```
