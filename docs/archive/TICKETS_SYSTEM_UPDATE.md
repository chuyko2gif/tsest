# Обновленная система тикетов поддержки

## Что нового

### 1. Аватарки и профили пользователей
- ✅ В админ панели отображаются аватарки пользователей в списке тикетов
- ✅ В чате показываются аватарки для всех сообщений (и пользователей, и админов)
- ✅ Отображается полная информация: никнейм, email, ID пользователя
- ✅ Данные профиля кэшируются в таблицах тикетов и сообщений для быстрой загрузки

### 2. Архивация закрытых тикетов
- ✅ При закрытии тикета он автоматически архивируется (добавляется `archived_at`)
- ✅ Архивные тикеты **не видны** пользователям в их кабинете
- ✅ Архивные тикеты доступны админам в отдельной вкладке "Архив"
- ✅ При переоткрытии тикета он автоматически выходит из архива

## Фильтры в админ панели

1. **Все** - активные неархивные тикеты всех статусов
2. **Активные** - открытые и в работе (неархивные)
3. **Закрытые** - закрытые но еще не архивированные
4. **Архив** - все архивированные тикеты (обычно закрытые старые тикеты)

## Что видит пользователь

Пользователь в своем кабинете видит **только активные неархивные тикеты**:
- Открытые тикеты
- Тикеты в работе
- Ожидающие ответа

После закрытия тикет исчезает из кабинета пользователя.

## Установка

### 1. Обновить структуру базы данных

Выполнить в PostgreSQL (через Supabase SQL Editor):

```sql
-- 1. Добавить архивацию
\i sql/add_archived_at_to_tickets.sql

-- 2. Добавить кэширование профилей
\i sql/add_profile_cache_to_tickets.sql
```

Или выполнить файлы по отдельности:
1. `sql/add_archived_at_to_tickets.sql` - добавляет поле `archived_at` и триггеры
2. `sql/add_profile_cache_to_tickets.sql` - добавляет кэширование данных профилей

### 2. Проверить работу

#### В админ панели:
1. Откройте раздел "Тикеты"
2. Проверьте отображение аватарок в списке тикетов
3. Откройте тикет и проверьте аватарки в сообщениях
4. Попробуйте фильтры: Все / Активные / Закрытые / Архив

#### В кабинете пользователя:
1. Откройте страницу поддержки
2. Проверьте отображение аватарок в сообщениях
3. Закройте тикет (из админки) и убедитесь, что он исчез из кабинета

## Технические детали

### Новые поля в базе данных

**Таблица `tickets`:**
- `archived_at` (timestamptz, nullable) - дата архивации
- `user_email` (text) - кэш email пользователя
- `user_username` (text) - кэш username пользователя
- `user_telegram` (text) - кэш telegram пользователя
- `user_avatar` (text) - кэш URL аватарки пользователя

**Таблица `ticket_messages`:**
- `sender_email` (text) - кэш email отправителя
- `sender_username` (text) - кэш username отправителя
- `sender_avatar` (text) - кэш URL аватарки отправителя
- `sender_nickname` (text) - кэш никнейма отправителя

### Триггеры

1. **auto_archive_on_close** - автоматически устанавливает `archived_at` при закрытии тикета
2. **populate_sender_profile** - заполняет данные профиля отправителя при создании сообщения
3. **populate_ticket_user_profile** - заполняет данные профиля пользователя при создании тикета

### API изменения

**PATCH /api/support/tickets/[id]:**
- При `status: 'closed'` автоматически добавляется `archived_at: NOW()`
- Возвращает обновленный тикет с полем `archived_at`

**GET /api/support/tickets:**
- Для пользователей: фильтрует `WHERE archived_at IS NULL`
- Для админов: возвращает все тикеты (включая архивные)

## Преимущества

1. **Производительность**: данные профилей кэшируются, не нужно делать JOIN при каждой загрузке
2. **UX для пользователей**: чистый список только активных тикетов
3. **UX для админов**: полный доступ к истории через архив
4. **Визуальная идентификация**: аватарки помогают быстро идентифицировать пользователей
5. **Автоматизация**: архивация происходит автоматически при закрытии

## Возможные улучшения

- [ ] Добавить массовую архивацию старых тикетов
- [ ] Добавить настройку автоархивации (через X дней после закрытия)
- [ ] Добавить экспорт архивных тикетов
- [ ] Синхронизация кэшированных данных при изменении профиля
