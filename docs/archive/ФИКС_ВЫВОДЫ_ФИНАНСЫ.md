# üîß –§–ò–ö–°: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤—ã–≤–æ–¥–æ–≤ —Å —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞

–í—ã–≤–æ–¥—ã (withdrawal_requests) –Ω–µ –±—ã–ª–∏ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã —Å —Å–∏—Å—Ç–µ–º–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π - —Å–æ–∑–¥–∞–≤–∞–ª–∏—Å—å –∑–∞—è–≤–∫–∏, –Ω–æ –±–∞–ª–∞–Ω—Å –Ω–µ —Å–ø–∏—Å—ã–≤–∞–ª—Å—è, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–µ —Å–æ–∑–¥–∞–≤–∞–ª–∏—Å—å.

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

–°–æ–∑–¥–∞–Ω –ø–æ–ª–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤.

---

## üöÄ –ß–¢–û –î–ï–õ–ê–¢–¨ –°–ï–ô–ß–ê–°

### 1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø–æ–ª–Ω—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É —Ñ–∏–Ω–∞–Ω—Å–æ–≤

–û—Ç–∫—Ä–æ–π—Ç–µ Supabase SQL Editor –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

```
sql/FULL_FINANCE_SETUP.sql
```

### 2. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –±–∞–ª–∞–Ω—Å—ã

–ï—Å–ª–∏ –µ—Å—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å:

```
sql/reset_all_balances.sql
```

---

## üìã –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### 1. –°–æ–∑–¥–∞–Ω `FULL_FINANCE_SETUP.sql`
–ü–æ–ª–Ω—ã–π —Å–∫—Ä–∏–ø—Ç, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç:
- ‚úÖ –¢–∞–±–ª–∏—Ü—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (`transactions`)
- ‚úÖ –¢–∞–±–ª–∏—Ü—É –∑–∞—è–≤–æ–∫ –Ω–∞ –≤—ã–≤–æ–¥ (`withdrawal_requests`)  
- ‚úÖ –§—É–Ω–∫—Ü–∏—é —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞–º–∏ (`create_transaction`)
- ‚úÖ –¢—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å payouts (–Ω–∞—á–∏—Å–ª–µ–Ω–∏—è)
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å withdrawal_requests (–≤—ã–≤–æ–¥—ã)
- ‚úÖ Realtime –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- ‚úÖ RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω `reset_all_balances.sql`
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞
- –î–æ–±–∞–≤–ª–µ–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ
- –£–ª—É—á—à–µ–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### 3. –°–æ–∑–¥–∞–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- `FINANCE_SYSTEM_SETUP.md` - –ø–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
- –≠—Ç–æ—Ç —Ñ–∞–π–ª - –∫—Ä–∞—Ç–∫–∏–π –≥–∞–π–¥

---

## üéØ –ö–∞–∫ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∏—Å—Ç–µ–º–∞

### –ù–∞—á–∏—Å–ª–µ–Ω–∏—è (Payouts)
```
–°–æ–∑–¥–∞–Ω payout ‚Üí –¢—Ä–∏–≥–≥–µ—Ä ‚Üí create_transaction('payout') ‚Üí –ë–∞–ª–∞–Ω—Å +
```

### –í—ã–≤–æ–¥—ã (Withdrawals)
```
–°–æ–∑–¥–∞–Ω–∞ –∑–∞—è–≤–∫–∞ ‚Üí –¢—Ä–∏–≥–≥–µ—Ä ‚Üí create_transaction('withdrawal') ‚Üí –ë–∞–ª–∞–Ω—Å -
                                                              ‚Üì
                                                    –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞
                                                    (–µ—Å–ª–∏ –º–∞–ª–æ - –æ—à–∏–±–∫–∞)
```

### –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏
```
status = 'rejected' ‚Üí –¢—Ä–∏–≥–≥–µ—Ä ‚Üí create_transaction('refund') ‚Üí –ë–∞–ª–∞–Ω—Å +
```

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è `FULL_FINANCE_SETUP.sql` –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

### 1. –¢—Ä–∏–≥–≥–µ—Ä—ã —Å–æ–∑–¥–∞–Ω—ã
```sql
SELECT trigger_name, event_object_table
FROM information_schema.triggers
WHERE trigger_name LIKE 'trg_%';
```

–î–æ–ª–∂–Ω—ã –±—ã—Ç—å:
- `trg_payout_created` –Ω–∞ `payouts`
- `trg_withdrawal_request_created` –Ω–∞ `withdrawal_requests`
- `trg_withdrawal_request_updated` –Ω–∞ `withdrawal_requests`

### 2. –§—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç
```sql
SELECT routine_name 
FROM information_schema.routines
WHERE routine_name = 'create_transaction';
```

### 3. Realtime –≤–∫–ª—é—á–µ–Ω
```sql
SELECT tablename
FROM pg_publication_tables
WHERE pubname = 'supabase_realtime'
  AND tablename IN ('transactions', 'withdrawal_requests');
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: –°–æ–∑–¥–∞–Ω–∏–µ –≤—ã–ø–ª–∞—Ç—ã
```sql
-- –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—É—é –≤—ã–ø–ª–∞—Ç—É
INSERT INTO payouts (user_id, amount, release_title, platform, period)
VALUES ('–≤–∞—à-user-id', 5000, 'Test Release', 'Spotify', '2024-12');

-- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–∞–ª–∞–Ω—Å –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
SELECT balance FROM profiles WHERE id = '–≤–∞—à-user-id';
SELECT * FROM transactions WHERE user_id = '–≤–∞—à-user-id' ORDER BY created_at DESC LIMIT 1;
```

### –¢–µ—Å—Ç 2: –ó–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–≤–æ–¥
```sql
-- –°–æ–∑–¥–∞–π—Ç–µ –∑–∞—è–≤–∫—É –Ω–∞ –≤—ã–≤–æ–¥
INSERT INTO withdrawal_requests (
  user_id, amount, bank_name, card_number, recipient_name
) VALUES (
  '–≤–∞—à-user-id', 2000, '–°–±–µ—Ä–±–∞–Ω–∫', '1234****5678', '–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤'
);

-- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–∞–ª–∞–Ω—Å (–¥–æ–ª–∂–µ–Ω —É–º–µ–Ω—å—à–∏—Ç—å—Å—è)
SELECT balance FROM profiles WHERE id = '–≤–∞—à-user-id';
SELECT * FROM transactions WHERE user_id = '–≤–∞—à-user-id' ORDER BY created_at DESC LIMIT 1;
```

### –¢–µ—Å—Ç 3: –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏
```sql
-- –û—Ç–∫–ª–æ–Ω–∏—Ç–µ –∑–∞—è–≤–∫—É
UPDATE withdrawal_requests 
SET status = 'rejected', admin_comment = '–¢–µ—Å—Ç–æ–≤–∞—è –∑–∞—è–≤–∫–∞'
WHERE user_id = '–≤–∞—à-user-id' AND status = 'pending';

-- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–∞–ª–∞–Ω—Å (–¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å—Å—è)
SELECT balance FROM profiles WHERE id = '–≤–∞—à-user-id';
SELECT * FROM transactions WHERE user_id = '–≤–∞—à-user-id' ORDER BY created_at DESC LIMIT 2;
```

---

## ‚ö†Ô∏è –í–∞–∂–Ω–æ

1. **Backup**: –°–¥–µ–ª–∞–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –ë–î –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —Å–∫—Ä–∏–ø—Ç–æ–≤
2. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –Ω–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
3. **–û—á–∏—Å—Ç–∫–∞**: –ï—Å–ª–∏ –µ—Å—Ç—å —Å—Ç–∞—Ä—ã–µ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `reset_all_balances.sql`

---

## üìû –ß—Ç–æ –¥–∞–ª—å—à–µ

1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ `FULL_FINANCE_SETUP.sql`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤
3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Å–æ–∑–¥–∞–Ω–∏–µ/–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –∑–∞—è–≤–æ–∫
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å - –±–∞–ª–∞–Ω—Å—ã –¥–æ–ª–∂–Ω—ã –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

**üéâ –ì–æ—Ç–æ–≤–æ! –°–∏—Å—Ç–µ–º–∞ –≤—ã–≤–æ–¥–æ–≤ —Ç–µ–ø–µ—Ä—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ —Å —Ñ–∏–Ω–∞–Ω—Å–∞–º–∏!**
