# Настройка восстановления пароля в Supabase

## 1. Настройка Redirect URLs

Перейдите в **Supabase Dashboard** → **Authentication** → **URL Configuration**

Добавьте следующие URL в список **Redirect URLs**:

```
http://localhost:3000/reset-password
http://localhost:3000/cabinet
```

Для production также добавьте:
```
https://ваш-домен.com/reset-password
https://ваш-домен.com/cabinet
```

## 2. Настройка Email Templates

### Reset Password (Восстановление пароля)

Перейдите в **Supabase Dashboard** → **Authentication** → **Email Templates** → **Reset Password**

Вставьте содержимое файла `email-templates/password-reset-template.html`

**ВАЖНО:** Убедитесь, что в шаблоне используется переменная `{{ .SiteURL }}` для кнопки восстановления, а НЕ `{{ .ConfirmationURL }}`

### Change Email (Смена email)

Перейдите в **Supabase Dashboard** → **Authentication** → **Email Templates** → **Change Email**

Вставьте содержимое файла `email-templates/email-change-template.html`

**ВАЖНО:** В этом шаблоне используется `{{ .ConfirmationURL }}` для подтверждения нового email

## 3. Проверка SMTP настроек

Убедитесь, что SMTP настроен в **Settings** → **Authentication** → **SMTP Settings**:

- **SMTP Host:** smtp-relay.brevo.com
- **SMTP Port:** 587
- **SMTP User:** maksbroska@gmail.com
- **Sender email:** maksbroska@gmail.com
- **Sender name:** thqlabel

## 4. Выполнить SQL скрипт

Выполните файл `sql/add_email_to_profiles.sql` в **SQL Editor**

Это добавит поле `email` в таблицу `profiles` для поиска по никнейму.

## 5. Тестирование

### Восстановление пароля:
1. На странице `/auth` нажмите "Забыли пароль?"
2. Введите email или никнейм
3. Проверьте почту
4. Кликните на кнопку "Восстановить пароль"
5. Введите новый пароль
6. После успешной смены вы будете перенаправлены в кабинет

### Смена пароля в настройках:
1. Войдите в кабинет
2. Перейдите в "Настройки"
3. Нажмите "Изменить пароль"
4. Введите новый пароль и подтверждение
5. Нажмите "Сохранить новый пароль"

### Смена email в настройках:
1. Войдите в кабинет
2. Перейдите в "Настройки"
3. Нажмите "Изменить email" под текущим email
4. Введите новый email
5. Нажмите "Отправить подтверждение"
6. Проверьте новый email
7. Кликните на кнопку "Подтвердить новый Email"
8. Email будет изменён автоматически

## Как работает система

### Восстановление по email:
1. Пользователь вводит email → письмо отправляется на email
2. Пользователь вводит никнейм → система ищет email в profiles → письмо отправляется на найденный email

### Безопасность:
- Каждая ссылка восстановления уникальна и действует 60 минут
- После использования ссылка становится недействительной
- Каждое новое письмо генерирует новую ссылку
- Смена пароля в настройках не требует текущего пароля (пользователь уже авторизован)

### Переменные в email шаблонах:
- `{{ .ConfirmationURL }}` - для **email verification** (регистрация)
- `{{ .SiteURL }}` - для **password reset** (восстановление пароля)
- Supabase автоматически добавляет токен в URL hash

## Troubleshooting

**Ошибка: "Недействительная ссылка"**
- Убедитесь что URL добавлен в Redirect URLs
- Проверьте что ссылка не истекла (60 минут)
- Запросите новое письмо для восстановления

**Письмо не приходит:**
- Проверьте папку "Спам"
- Убедитесь что sender email верифицирован в Brevo
- Проверьте SMTP настройки в Supabase

**"User not found":**
- Убедитесь что SQL скрипт выполнен
- Проверьте что email есть в таблице profiles
- Попробуйте ввести email вместо никнейма
