# Система черновиков для релизов

## Что реализовано

### 1. База данных
- ✅ Создан SQL скрипт `sql/add_draft_status.sql` для добавления статуса `draft`
- ✅ Статусы: `draft`, `pending`, `approved`, `rejected`, `published`
- ✅ Дефолтное значение изменено на `draft`

### 2. Автосохранение (Exclusive)
- ✅ Функция `saveDraft()` автоматически сохраняет прогресс каждые 30 секунд
- ✅ Сохранение при переключении между шагами
- ✅ Создание нового черновика или обновление существующего
- ✅ Хранение `draftId` в состоянии компонента

### 3. Интерфейс кабинета
- ✅ Добавлены три вкладки: "Exclusive", "Basic", "Черновики"
- ✅ Счетчик количества черновиков
- ✅ Фильтрация релизов по типу и статусу
- ✅ Черновики отображаются с серой меткой "Черновик"
- ✅ При клике на черновик - переход к редактированию

### 4. Отправка на модерацию
- ✅ При отправке статус меняется с `draft` на `pending`
- ✅ Если существует `draftId` - обновляется существующая запись
- ✅ Если нет - создается новая
- ✅ Добавлено поле `status_updated_at`

## Как применить

### Шаг 1: Обновить базу данных
Выполните SQL скрипт в Supabase SQL Editor:
```bash
# Откройте файл sql/add_draft_status.sql и выполните его в Supabase
```

### Шаг 2: Проверка работы
1. Откройте страницу создания Exclusive релиза
2. Начните заполнять форму
3. Подождите 30 секунд или переключите шаг
4. Проверьте в базе данных - должна появиться запись со статусом `draft`
5. Закройте страницу и откройте кабинет
6. Перейдите на вкладку "Черновики"
7. Нажмите на черновик - откроется страница редактирования
8. Заполните все обязательные поля и отправьте на модерацию
9. Статус должен измениться на `pending`

## Что нужно доделать

### 1. Добавить автосохранение для Basic релизов
Скопируйте логику из `app/cabinet/release/create/page.tsx` в `app/cabinet/release-basic/create/page.tsx`:
- Состояния `draftId` и `isSavingDraft`
- Функцию `saveDraft()`
- useEffect с интервалом
- useEffect при изменении шага
- Передать `draftId` в SendStep

### 2. Обновить SendStep для Basic
Добавьте поддержку `draftId` в:
- `app/cabinet/release-basic/create/components/SendStep.tsx`
- Аналогично Exclusive версии

### 3. Добавить индикатор автосохранения (опционально)
Можно добавить текст "Автосохранено" или иконку в интерфейсе:
```tsx
{isSavingDraft && (
  <div className="text-xs text-zinc-500">Сохранение...</div>
)}
```

### 4. Очистка старых черновиков (опционально)
Создать функцию для автоматического удаления черновиков старше 30 дней:
```sql
DELETE FROM releases_exclusive 
WHERE status = 'draft' 
AND created_at < NOW() - INTERVAL '30 days';
```

## Технические детали

### Структура данных черновика
При сохранении черновика сохраняются все поля:
- Основная информация (title, artist_name, genre, etc.)
- Треки (JSONB)
- Страны
- Платформы
- Промо информация
- Контракт
- Статус: `draft`

### Логика работы
1. **При открытии формы создания**: Не загружается автоматически
2. **При первом автосохранении**: Создается черновик с `status=draft`
3. **При последующих автосохранениях**: Обновляется существующий черновик
4. **При отправке**: Статус меняется на `pending`
5. **При клике на черновик в кабинете**: Открывается страница edit с загрузкой данных

### Различия между create и edit
- **Create**: Автосохранение в черновик, при отправке проверяется наличие `draftId`
- **Edit**: Редактирование существующего релиза (draft или pending)

## Дополнительные улучшения (будущее)

1. **Восстановление после закрытия вкладки**: Использовать localStorage для временного хранения
2. **Конфликты версий**: Добавить проверку updated_at при сохранении
3. **История изменений**: Логировать изменения черновика
4. **Уведомления**: Показывать toast при успешном автосохранении
5. **Оффлайн режим**: Сохранять в localStorage если нет связи с сервером

## Безопасность

- ✅ Проверка `user_id` при создании и обновлении
- ✅ RLS политики Supabase применяются автоматически
- ✅ Черновики видны только их создателю
- ✅ Админы не имеют доступа к чужим черновикам (по дизайну)
